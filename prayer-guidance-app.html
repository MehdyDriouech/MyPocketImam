<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Pocket Imam</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .font-arabic {
            font-family: 'Traditional Arabic', 'Arabic Typesetting', 'Geeza Pro', serif;
        }
        .prayer-image {
            transition: all 0.5s ease-in-out;
            max-height: 350px;
            object-fit: contain;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-teal-50 via-emerald-50 to-cyan-50 min-h-screen">
    <div id="app">
        <!-- Loading screen while translations load -->
        <div class="flex items-center justify-center min-h-screen">
            <div class="text-center">
                <div class="text-6xl mb-4">üïå</div>
                <div class="text-2xl font-bold text-teal-800 mb-2">Loading...</div>
                <div class="animate-pulse text-teal-600">Chargement... ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ...</div>
            </div>
        </div>
    </div>

    <script>
        // Translations will be loaded from external JSON file
        let TRANSLATIONS = null;
        let translationsLoaded = false;

        // Inline translations as fallback (for use without server)
        const INLINE_TRANSLATIONS = {
  "fr": {
    "appTitle": "My Pocket Imam",
    "subtitle": "Apprenez et pratiquez vos pri√®res quotidiennes",
    "reciter": "R√©citateur",
    "reciterName": "Saad El Ghamidi",
    "rakaats": "Rakaats",
    "back": "Retour",
    "config": "Config",
    "configuration": "Configuration",
    "settings": "Param√®tres",
    "mandatorySurah": "Al-Fatiha (Obligatoire)",
    "secondarySurah": "Sourate secondaire",
    "infoRakaat34": "Pour les rakaats 3 et 4, seule Al-Fatiha est r√©cit√©e",
    "startGuidance": "D√©marrer le guidage",
    "scenarioMode": "Mode Sc√©nario",
    "automaticFlow": "D√©roulement automatique des √©tapes",
    "automaticActive": "Mode automatique activ√© - Les √©tapes s'encha√Ænent automatiquement",
    "listenRecitation": "√âcouter la r√©citation",
    "pause": "Pause",
    "playing": "Lecture en cours...",
    "waiting": "En attente...",
    "variant": "Variante",
    "previous": "Pr√©c√©dent",
    "next": "Suivant",
    "prayerComplete": "Pri√®re termin√©e !",
    "prayerAccepted": "Qu'Allah accepte votre pri√®re",
    "returnHome": "Retour √† l'accueil",
    "rakaat": "Rakaat",
    "language": "Langue",
    "avatar": "Avatar",
    "boy": "Gar√ßon",
    "girl": "Fille",
    "selectReciter": "S√©lectionner le r√©citateur",
    "selectAvatar": "S√©lectionner l'avatar",
    "city": "Ville",
    "country": "Code Pays (ISO 3166)",
    "enterCity": "Entrez le nom de votre ville",
    "enterCountry": "Entrez le code pays √† 2 lettres (ex: FR, UK, SA)",
    "cityPlaceholder": "Paris",
    "countryPlaceholder": "FR",
    "calculationMethod": "M√©thode de calcul",
    "selectCalculationMethod": "S√©lectionner la m√©thode de calcul",
    "saveSettings": "Enregistrer les param√®tres",
    "donations": "Soutenir le projet",
    "donationsMessage": "Ce projet est gratuit et le restera toujours. Vos dons servent uniquement √† couvrir les frais d'h√©bergement. Tout surplus sera revers√© √† des ≈ìuvres de charit√© musulmanes.",
    "supportProject": "Faire un don",
    "openSource": "Code Open-Source",
    "openSourceMessage": "Ce projet est d√©velopp√© comme une ≈ìuvre pour Allah Ô∑ª. Le code est enti√®rement open-source et libre d'utilisation. Vous pouvez le t√©l√©charger, le modifier et le partager.",
    "openSourceWarning": "‚ö†Ô∏è Important : Ce projet ne doit en aucun cas √™tre commercialis√© ou vendu. C'est une sadaqa jariya (charit√© continue) offerte √† la communaut√©.",
    "viewOnGithub": "Voir sur GitHub",
    "downloadCode": "T√©l√©charger le code source",
    "loadingPrayerTimes": "Chargement des horaires...",
    "location": "Localisation",
    "takbirOpening": "Takbir d'ouverture",
    "openingInvocation": "Invocation d'ouverture",
    "seekingRefuge": "Demande de refuge",
    "bismillah": "Bismillah",
    "reciteFatiha": "R√©citation Al-Fatiha",
    "secondarySurahStep": "Sourate secondaire",
    "takbirRuku": "Takbir pour le Ruku",
    "ruku": "Ruku (Inclinaison)",
    "qiyam": "Qiyam (Retour debout)",
    "afterQiyam": "Apr√®s le Qiyam",
    "takbirSujud": "Takbir pour la prosternation",
    "sujud1": "Sujud 1 (Prosternation)",
    "takbirSit": "Takbir pour s'asseoir",
    "jalsa": "Jalsa (Position assise)",
    "takbirSujud2": "Takbir pour la 2√®me prosternation",
    "sujud2": "Sujud 2 (Prosternation)",
    "tashahhud": "Tashahhud",
    "ibrahimicPrayer": "Pri√®re Ibrahimique",
    "finalInvocation": "Invocation finale",
    "salamRight": "Salam √† droite",
    "salamLeft": "Salam √† gauche",
    "raiseHands": "Levez les mains au niveau des oreilles et dites",
    "reciteOpening": "R√©citez l'invocation d'ouverture",
    "seekProtection": "Demandez la protection d'Allah",
    "beginWithName": "Commencez par le nom d'Allah",
    "reciteFatihaAction": "R√©citez la sourate Al-Fatiha",
    "reciteSecondary": "R√©citez la sourate secondaire s√©lectionn√©e",
    "sayTakbirBowing": "Dites Allahu Akbar en vous inclinant",
    "stayBowing": "Restez en inclinaison et glorifiez Allah",
    "standUpSaying": "Relevez-vous en disant",
    "onceStanding": "Une fois debout, dites",
    "sayTakbirProstrating": "Dites Allahu Akbar en vous prosternant",
    "stayProstrating": "Restez en prosternation et glorifiez Allah",
    "sayTakbirSitting": "Dites Allahu Akbar en vous relevant",
    "sitBriefly": "Asseyez-vous bri√®vement entre les deux prosternations",
    "sayTakbirProstrating2": "Dites Allahu Akbar en vous prosternant √† nouveau",
    "prostrateAgain": "Prosternez-vous √† nouveau et glorifiez Allah",
    "standAndSit": "Relevez-vous et asseyez-vous",
    "reciteTashahhud": "R√©citez le Tashahhud",
    "reciteIbrahimic": "R√©citez la pri√®re Ibrahimique",
    "makeInvocations": "Faites des invocations personnelles",
    "turnRightGreet": "Tournez la t√™te vers la droite et saluez",
    "turnLeftGreet": "Tournez la t√™te vers la gauche et saluez",
    "hadithOfTheDay": "Hadith du Jour",
    "loadingHadith": "Chargement du hadith...",
    "hadithError": "Erreur lors du chargement du hadith",
    "refresh": "Rafra√Æchir",
    "retry": "R√©essayer",
    "prayers": {
      "fajr": "Fajr",
      "dohr": "Dohr",
      "asr": "Asr",
      "maghreb": "Maghreb",
      "isha": "Isha"
    },
    "surahs": {
      "fatiha": "Al-Fatiha",
      "ikhlas": "Al-Ikhlas",
      "falaq": "Al-Falaq",
      "nas": "An-Nas",
      "kafirun": "Al-Kafirun",
      "asr": "Al-Asr",
      "qadr": "Al-Qadr"
    },
    "calculationMethods": {
      "3": "Ligue Islamique Mondiale",
      "2": "ISNA (Am√©rique du Nord)",
      "5": "Autorit√© √âgyptienne",
      "4": "Umm Al-Qura (La Mecque)",
      "1": "Universit√© de Karachi",
      "0": "Chiite Ithna-Ashari",
      "7": "T√©h√©ran",
      "8": "R√©gion du Golfe",
      "9": "Kowe√Øt",
      "10": "Qatar",
      "11": "Singapour",
      "12": "France (UOIF)",
      "13": "Turquie (Diyanet)",
      "14": "Russie",
      "16": "Duba√Ø",
      "17": "Malaisie (JAKIM)",
      "18": "Tunisie",
      "19": "Alg√©rie",
      "20": "Indon√©sie (KEMENAG)",
      "21": "Maroc",
      "22": "Portugal",
      "23": "Jordanie"
    }
  },
  "en": {
    "appTitle": "My Pocket Imam",
    "subtitle": "Learn and practice your daily prayers",
    "reciter": "Reciter",
    "reciterName": "Saad El Ghamidi",
    "rakaats": "Rakaats",
    "back": "Back",
    "config": "Config",
    "configuration": "Configuration",
    "settings": "Settings",
    "mandatorySurah": "Al-Fatiha (Mandatory)",
    "secondarySurah": "Secondary Surah",
    "infoRakaat34": "For rakaats 3 and 4, only Al-Fatiha is recited",
    "startGuidance": "Start Guidance",
    "scenarioMode": "Scenario Mode",
    "automaticFlow": "Automatic flow of steps",
    "automaticActive": "Automatic mode activated - Steps flow automatically",
    "listenRecitation": "Listen to recitation",
    "pause": "Pause",
    "playing": "Playing...",
    "waiting": "Waiting...",
    "variant": "Variant",
    "previous": "Previous",
    "next": "Next",
    "prayerComplete": "Prayer Complete!",
    "prayerAccepted": "May Allah accept your prayer",
    "returnHome": "Return Home",
    "rakaat": "Rakaat",
    "language": "Language",
    "avatar": "Avatar",
    "boy": "Boy",
    "girl": "Girl",
    "selectReciter": "Select Reciter",
    "selectAvatar": "Select Avatar",
    "city": "City",
    "country": "Country Code (ISO 3166)",
    "enterCity": "Enter your city name",
    "enterCountry": "Enter 2-letter country code (e.g. FR, UK, SA)",
    "cityPlaceholder": "London",
    "countryPlaceholder": "GB",
    "calculationMethod": "Calculation Method",
    "selectCalculationMethod": "Select calculation method",
    "saveSettings": "Save Settings",
    "donations": "Support the Project",
    "donationsMessage": "This project is free and will always remain free. Your donations are used solely to cover hosting costs. Any surplus will be donated to Muslim charities.",
    "supportProject": "Make a Donation",
    "openSource": "Open-Source Code",
    "openSourceMessage": "This project is developed as a work for Allah Ô∑ª. The code is entirely open-source and free to use. You can download it, modify it, and share it.",
    "openSourceWarning": "‚ö†Ô∏è Important: This project must not be commercialized or sold under any circumstances. It is a sadaqa jariya (continuous charity) offered to the community.",
    "viewOnGithub": "View on GitHub",
    "downloadCode": "Download Source Code",
    "loadingPrayerTimes": "Loading prayer times...",
    "location": "Location",
    "takbirOpening": "Opening Takbir",
    "openingInvocation": "Opening Invocation",
    "seekingRefuge": "Seeking Refuge",
    "bismillah": "Bismillah",
    "reciteFatiha": "Reciting Al-Fatiha",
    "secondarySurahStep": "Secondary Surah",
    "takbirRuku": "Takbir for Ruku",
    "ruku": "Ruku (Bowing)",
    "qiyam": "Qiyam (Standing Up)",
    "afterQiyam": "After Qiyam",
    "takbirSujud": "Takbir for Prostration",
    "sujud1": "Sujud 1 (Prostration)",
    "takbirSit": "Takbir to Sit",
    "jalsa": "Jalsa (Sitting Position)",
    "takbirSujud2": "Takbir for 2nd Prostration",
    "sujud2": "Sujud 2 (Prostration)",
    "tashahhud": "Tashahhud",
    "ibrahimicPrayer": "Ibrahimic Prayer",
    "finalInvocation": "Final Invocation",
    "salamRight": "Salam to the Right",
    "salamLeft": "Salam to the Left",
    "raiseHands": "Raise your hands to ear level and say",
    "reciteOpening": "Recite the opening invocation",
    "seekProtection": "Seek Allah's protection",
    "beginWithName": "Begin with Allah's name",
    "reciteFatihaAction": "Recite Surah Al-Fatiha",
    "reciteSecondary": "Recite the selected secondary surah",
    "sayTakbirBowing": "Say Allahu Akbar while bowing",
    "stayBowing": "Stay in bowing position and glorify Allah",
    "standUpSaying": "Stand up saying",
    "onceStanding": "Once standing, say",
    "sayTakbirProstrating": "Say Allahu Akbar while prostrating",
    "stayProstrating": "Stay in prostration and glorify Allah",
    "sayTakbirSitting": "Say Allahu Akbar while rising",
    "sitBriefly": "Sit briefly between the two prostrations",
    "sayTakbirProstrating2": "Say Allahu Akbar while prostrating again",
    "prostrateAgain": "Prostrate again and glorify Allah",
    "standAndSit": "Stand up and sit down",
    "reciteTashahhud": "Recite the Tashahhud",
    "reciteIbrahimic": "Recite the Ibrahimic prayer",
    "makeInvocations": "Make personal invocations",
    "turnRightGreet": "Turn your head to the right and greet",
    "turnLeftGreet": "Turn your head to the left and greet",
    "hadithOfTheDay": "Hadith of the Day",
    "loadingHadith": "Loading hadith...",
    "hadithError": "Error loading hadith",
    "refresh": "Refresh",
    "retry": "Retry",
    "prayers": {
      "fajr": "Fajr",
      "dohr": "Dhuhr",
      "asr": "Asr",
      "maghreb": "Maghrib",
      "isha": "Isha"
    },
    "surahs": {
      "fatiha": "Al-Fatiha",
      "ikhlas": "Al-Ikhlas",
      "falaq": "Al-Falaq",
      "nas": "An-Nas",
      "kafirun": "Al-Kafirun",
      "asr": "Al-Asr",
      "qadr": "Al-Qadr"
    },
    "calculationMethods": {
      "3": "Muslim World League",
      "2": "ISNA (North America)",
      "5": "Egyptian Authority",
      "4": "Umm Al-Qura (Makkah)",
      "1": "University of Karachi",
      "0": "Shia Ithna-Ashari",
      "7": "Tehran",
      "8": "Gulf Region",
      "9": "Kuwait",
      "10": "Qatar",
      "11": "Singapore",
      "12": "France (UOIF)",
      "13": "Turkey (Diyanet)",
      "14": "Russia",
      "16": "Dubai",
      "17": "Malaysia (JAKIM)",
      "18": "Tunisia",
      "19": "Algeria",
      "20": "Indonesia (KEMENAG)",
      "21": "Morocco",
      "22": "Portugal",
      "23": "Jordan"
    }
  },
  "ar": {
    "appTitle": "ÿ•ÿ±ÿ¥ÿßÿØ ÿßŸÑÿµŸÑÿßÿ©",
    "subtitle": "ÿ™ÿπŸÑŸÖ ŸàŸÖŸÖÿßÿ±ÿ≥ÿ© ÿµŸÑŸàÿßÿ™ŸÉ ÿßŸÑŸäŸàŸÖŸäÿ©",
    "reciter": "ÿßŸÑŸÇÿßÿ±ÿ¶",
    "reciterName": "ÿ≥ÿπÿØ ÿßŸÑÿ∫ÿßŸÖÿØŸä",
    "rakaats": "ÿ±ŸÉÿπÿßÿ™",
    "back": "ÿ±ÿ¨Ÿàÿπ",
    "config": "ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™",
    "configuration": "ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™",
    "settings": "ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™",
    "mandatorySurah": "ÿßŸÑŸÅÿßÿ™ÿ≠ÿ© (ÿ•ŸÑÿ≤ÿßŸÖŸäÿ©)",
    "secondarySurah": "ÿßŸÑÿ≥Ÿàÿ±ÿ© ÿßŸÑÿ´ÿßŸÜŸàŸäÿ©",
    "infoRakaat34": "ŸÑŸÑÿ±ŸÉÿπÿßÿ™ 3 Ÿà 4ÿå ÿ™ŸèŸÇÿ±ÿ£ ÿßŸÑŸÅÿßÿ™ÿ≠ÿ© ŸÅŸÇÿ∑",
    "startGuidance": "ÿ®ÿØÿ° ÿßŸÑÿ•ÿ±ÿ¥ÿßÿØ",
    "scenarioMode": "ÿßŸÑŸàÿ∂ÿπ ÿßŸÑÿ™ŸÑŸÇÿßÿ¶Ÿä",
    "automaticFlow": "ÿßŸÑÿ™ÿØŸÅŸÇ ÿßŸÑÿ™ŸÑŸÇÿßÿ¶Ÿä ŸÑŸÑÿÆÿ∑Ÿàÿßÿ™",
    "automaticActive": "ÿßŸÑŸàÿ∂ÿπ ÿßŸÑÿ™ŸÑŸÇÿßÿ¶Ÿä ŸÖŸèŸÅÿπŸÑ - ÿ™ÿ™ÿØŸÅŸÇ ÿßŸÑÿÆÿ∑Ÿàÿßÿ™ ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸã",
    "listenRecitation": "ÿßÿ≥ÿ™ŸÖÿπ ŸÑŸÑÿ™ŸÑÿßŸàÿ©",
    "pause": "ÿ•ŸäŸÇÿßŸÅ ŸÖÿ§ŸÇÿ™",
    "playing": "ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ¥ÿ∫ŸäŸÑ...",
    "waiting": "ŸÅŸä ÿßŸÑÿßŸÜÿ™ÿ∏ÿßÿ±...",
    "variant": "ŸÖÿ™ÿ∫Ÿäÿ±",
    "previous": "ÿßŸÑÿ≥ÿßÿ®ŸÇ",
    "next": "ÿßŸÑÿ™ÿßŸÑŸä",
    "prayerComplete": "ÿßŸÉÿ™ŸÖŸÑÿ™ ÿßŸÑÿµŸÑÿßÿ©!",
    "prayerAccepted": "ÿ™ŸÇÿ®ŸÑ ÿßŸÑŸÑŸá ÿµŸÑÿßÿ™ŸÉ",
    "returnHome": "ÿßŸÑÿπŸàÿØÿ© ŸÑŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ©",
    "rakaat": "ÿ±ŸÉÿπÿ©",
    "language": "ÿßŸÑŸÑÿ∫ÿ©",
    "avatar": "ÿßŸÑÿµŸàÿ±ÿ© ÿßŸÑÿ±ŸÖÿ≤Ÿäÿ©",
    "boy": "ŸàŸÑÿØ",
    "girl": "ÿ®ŸÜÿ™",
    "selectReciter": "ÿßÿÆÿ™ÿ± ÿßŸÑŸÇÿßÿ±ÿ¶",
    "selectAvatar": "ÿßÿÆÿ™ÿ± ÿßŸÑÿµŸàÿ±ÿ© ÿßŸÑÿ±ŸÖÿ≤Ÿäÿ©",
    "city": "ÿßŸÑŸÖÿØŸäŸÜÿ©",
    "country": "ÿ±ŸÖÿ≤ ÿßŸÑÿØŸàŸÑÿ© (ISO 3166)",
    "enterCity": "ÿ£ÿØÿÆŸÑ ÿßÿ≥ŸÖ ŸÖÿØŸäŸÜÿ™ŸÉ",
    "enterCountry": "ÿ£ÿØÿÆŸÑ ÿ±ŸÖÿ≤ ÿßŸÑÿØŸàŸÑÿ© ÿßŸÑŸÖŸÉŸàŸÜ ŸÖŸÜ ÿ≠ÿ±ŸÅŸäŸÜ (ŸÖÿ´ÿßŸÑ: SA, FR, GB)",
    "cityPlaceholder": "ÿßŸÑÿ±Ÿäÿßÿ∂",
    "countryPlaceholder": "SA",
    "calculationMethod": "ÿ∑ÿ±ŸäŸÇÿ© ÿßŸÑÿ≠ÿ≥ÿßÿ®",
    "selectCalculationMethod": "ÿßÿÆÿ™ÿ± ÿ∑ÿ±ŸäŸÇÿ© ÿßŸÑÿ≠ÿ≥ÿßÿ®",
    "saveSettings": "ÿ≠ŸÅÿ∏ ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™",
    "donations": "ÿØÿπŸÖ ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ",
    "donationsMessage": "Ÿáÿ∞ÿß ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ ŸÖÿ¨ÿßŸÜŸä Ÿàÿ≥Ÿäÿ®ŸÇŸâ ŸÖÿ¨ÿßŸÜŸäÿßŸã ÿØÿßÿ¶ŸÖÿßŸã. ÿ™ÿ≥ÿ™ÿÆÿØŸÖ ÿ™ÿ®ÿ±ÿπÿßÿ™ŸÉ ŸÅŸÇÿ∑ ŸÑÿ™ÿ∫ÿ∑Ÿäÿ© ÿ™ŸÉÿßŸÑŸäŸÅ ÿßŸÑÿßÿ≥ÿ™ÿ∂ÿßŸÅÿ©. ÿ≥Ÿäÿ™ŸÖ ÿßŸÑÿ™ÿ®ÿ±ÿπ ÿ®ÿ£Ÿä ŸÅÿßÿ¶ÿ∂ ŸÑŸÑÿ¨ŸÖÿπŸäÿßÿ™ ÿßŸÑÿÆŸäÿ±Ÿäÿ© ÿßŸÑÿ•ÿ≥ŸÑÿßŸÖŸäÿ©.",
    "supportProject": "ÿ™ÿ®ÿ±ÿπ ÿßŸÑÿ¢ŸÜ",
    "openSource": "ÿßŸÑŸÉŸàÿØ ŸÖŸÅÿ™Ÿàÿ≠ ÿßŸÑŸÖÿµÿØÿ±",
    "openSourceMessage": "ÿ™ŸÖ ÿ™ÿ∑ŸàŸäÿ± Ÿáÿ∞ÿß ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ ŸÉÿπŸÖŸÑ ŸÑŸÑŸá Ô∑ª. ÿßŸÑŸÉŸàÿØ ŸÖŸÅÿ™Ÿàÿ≠ ÿßŸÑŸÖÿµÿØÿ± ÿ®ÿßŸÑŸÉÿßŸÖŸÑ ŸàŸÖÿ¨ÿßŸÜŸä ŸÑŸÑÿßÿ≥ÿ™ÿÆÿØÿßŸÖ. ŸäŸÖŸÉŸÜŸÉ ÿ™ŸÜÿ≤ŸäŸÑŸá Ÿàÿ™ÿπÿØŸäŸÑŸá ŸàŸÖÿ¥ÿßÿ±ŸÉÿ™Ÿá.",
    "openSourceWarning": "‚ö†Ô∏è ŸÖŸáŸÖ: Ÿäÿ¨ÿ® ÿπÿØŸÖ ÿ™ÿ≥ŸàŸäŸÇ Ÿáÿ∞ÿß ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ ÿ£Ÿà ÿ®ŸäÿπŸá ÿ™ÿ≠ÿ™ ÿ£Ÿä ÿ∏ÿ±ŸÅ ŸÖŸÜ ÿßŸÑÿ∏ÿ±ŸàŸÅ. ÿ•ŸÜŸáÿß ÿµÿØŸÇÿ© ÿ¨ÿßÿ±Ÿäÿ© ŸÖŸÇÿØŸÖÿ© ŸÑŸÑŸÖÿ¨ÿ™ŸÖÿπ.",
    "viewOnGithub": "ÿπÿ±ÿ∂ ÿπŸÑŸâ GitHub",
    "downloadCode": "ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÉŸàÿØ ÿßŸÑŸÖÿµÿØÿ±Ÿä",
    "loadingPrayerTimes": "ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ŸÖŸäŸÑ ÿ£ŸàŸÇÿßÿ™ ÿßŸÑÿµŸÑÿßÿ©...",
    "location": "ÿßŸÑŸÖŸàŸÇÿπ",
    "takbirOpening": "ÿ™ŸÉÿ®Ÿäÿ±ÿ© ÿßŸÑÿ•ÿ≠ÿ±ÿßŸÖ",
    "openingInvocation": "ÿØÿπÿßÿ° ÿßŸÑÿßÿ≥ÿ™ŸÅÿ™ÿßÿ≠",
    "seekingRefuge": "ÿßŸÑÿßÿ≥ÿ™ÿπÿßÿ∞ÿ©",
    "bismillah": "ÿßŸÑÿ®ÿ≥ŸÖŸÑÿ©",
    "reciteFatiha": "ŸÇÿ±ÿßÿ°ÿ© ÿßŸÑŸÅÿßÿ™ÿ≠ÿ©",
    "secondarySurahStep": "ÿßŸÑÿ≥Ÿàÿ±ÿ© ÿßŸÑÿ´ÿßŸÜŸàŸäÿ©",
    "takbirRuku": "ÿßŸÑÿ™ŸÉÿ®Ÿäÿ± ŸÑŸÑÿ±ŸÉŸàÿπ",
    "ruku": "ÿßŸÑÿ±ŸÉŸàÿπ",
    "qiyam": "ÿßŸÑŸÇŸäÿßŸÖ",
    "afterQiyam": "ÿ®ÿπÿØ ÿßŸÑŸÇŸäÿßŸÖ",
    "takbirSujud": "ÿßŸÑÿ™ŸÉÿ®Ÿäÿ± ŸÑŸÑÿ≥ÿ¨ŸàÿØ",
    "sujud1": "ÿßŸÑÿ≥ÿ¨ŸàÿØ ÿßŸÑÿ£ŸàŸÑ",
    "takbirSit": "ÿßŸÑÿ™ŸÉÿ®Ÿäÿ± ŸÑŸÑÿ¨ŸÑŸàÿ≥",
    "jalsa": "ÿßŸÑÿ¨ŸÑÿ≥ÿ©",
    "takbirSujud2": "ÿßŸÑÿ™ŸÉÿ®Ÿäÿ± ŸÑŸÑÿ≥ÿ¨ŸàÿØ ÿßŸÑÿ´ÿßŸÜŸä",
    "sujud2": "ÿßŸÑÿ≥ÿ¨ŸàÿØ ÿßŸÑÿ´ÿßŸÜŸä",
    "tashahhud": "ÿßŸÑÿ™ÿ¥ŸáÿØ",
    "ibrahimicPrayer": "ÿßŸÑÿµŸÑÿßÿ© ÿßŸÑÿ•ÿ®ÿ±ÿßŸáŸäŸÖŸäÿ©",
    "finalInvocation": "ÿßŸÑÿØÿπÿßÿ° ÿßŸÑÿÆÿ™ÿßŸÖŸä",
    "salamRight": "ÿßŸÑÿ≥ŸÑÿßŸÖ ÿπŸÑŸâ ÿßŸÑŸäŸÖŸäŸÜ",
    "salamLeft": "ÿßŸÑÿ≥ŸÑÿßŸÖ ÿπŸÑŸâ ÿßŸÑŸäÿ≥ÿßÿ±",
    "raiseHands": "ÿßÿ±ŸÅÿπ ŸäÿØŸäŸÉ ÿ•ŸÑŸâ ŸÖÿ≥ÿ™ŸàŸâ ÿßŸÑÿ£ÿ∞ŸÜŸäŸÜ ŸàŸÇŸÑ",
    "reciteOpening": "ÿßŸÇÿ±ÿ£ ÿØÿπÿßÿ° ÿßŸÑÿßÿ≥ÿ™ŸÅÿ™ÿßÿ≠",
    "seekProtection": "ÿßÿ≥ÿ™ÿπÿ∞ ÿ®ÿßŸÑŸÑŸá",
    "beginWithName": "ÿßÿ®ÿØÿ£ ÿ®ÿßÿ≥ŸÖ ÿßŸÑŸÑŸá",
    "reciteFatihaAction": "ÿßŸÇÿ±ÿ£ ÿ≥Ÿàÿ±ÿ© ÿßŸÑŸÅÿßÿ™ÿ≠ÿ©",
    "reciteSecondary": "ÿßŸÇÿ±ÿ£ ÿßŸÑÿ≥Ÿàÿ±ÿ© ÿßŸÑÿ´ÿßŸÜŸàŸäÿ© ÿßŸÑŸÖÿÆÿ™ÿßÿ±ÿ©",
    "sayTakbirBowing": "ŸÇŸÑ ÿßŸÑŸÑŸá ÿ£ŸÉÿ®ÿ± ÿπŸÜÿØ ÿßŸÑÿ±ŸÉŸàÿπ",
    "stayBowing": "ÿßÿ®ŸÇ ŸÅŸä Ÿàÿ∂ÿπ ÿßŸÑÿ±ŸÉŸàÿπ Ÿàÿ≥ÿ®ÿ≠ ÿßŸÑŸÑŸá",
    "standUpSaying": "ŸÇŸÖ Ÿàÿ£ŸÜÿ™ ÿ™ŸÇŸàŸÑ",
    "onceStanding": "ÿ®ŸÖÿ¨ÿ±ÿØ ÿßŸÑŸàŸÇŸàŸÅÿå ŸÇŸÑ",
    "sayTakbirProstrating": "ŸÇŸÑ ÿßŸÑŸÑŸá ÿ£ŸÉÿ®ÿ± ÿπŸÜÿØ ÿßŸÑÿ≥ÿ¨ŸàÿØ",
    "stayProstrating": "ÿßÿ®ŸÇ ÿ≥ÿßÿ¨ÿØÿßŸã Ÿàÿ≥ÿ®ÿ≠ ÿßŸÑŸÑŸá",
    "sayTakbirSitting": "ŸÇŸÑ ÿßŸÑŸÑŸá ÿ£ŸÉÿ®ÿ± ÿπŸÜÿØ ÿßŸÑÿ¨ŸÑŸàÿ≥",
    "sitBriefly": "ÿßÿ¨ŸÑÿ≥ ŸÑŸÅÿ™ÿ±ÿ© Ÿàÿ¨Ÿäÿ≤ÿ© ÿ®ŸäŸÜ ÿßŸÑÿ≥ÿ¨ÿØÿ™ŸäŸÜ",
    "sayTakbirProstrating2": "ŸÇŸÑ ÿßŸÑŸÑŸá ÿ£ŸÉÿ®ÿ± ÿπŸÜÿØ ÿßŸÑÿ≥ÿ¨ŸàÿØ ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ",
    "prostrateAgain": "ÿßÿ≥ÿ¨ÿØ ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ Ÿàÿ≥ÿ®ÿ≠ ÿßŸÑŸÑŸá",
    "standAndSit": "ŸÇŸÖ Ÿàÿßÿ¨ŸÑÿ≥",
    "reciteTashahhud": "ÿßŸÇÿ±ÿ£ ÿßŸÑÿ™ÿ¥ŸáÿØ",
    "reciteIbrahimic": "ÿßŸÇÿ±ÿ£ ÿßŸÑÿµŸÑÿßÿ© ÿßŸÑÿ•ÿ®ÿ±ÿßŸáŸäŸÖŸäÿ©",
    "makeInvocations": "ÿßÿØÿπ ÿ®ÿØÿπŸàÿßÿ™ŸÉ ÿßŸÑÿ¥ÿÆÿµŸäÿ©",
    "turnRightGreet": "ÿßŸÑÿ™ŸÅÿ™ ÿ®ÿ±ÿ£ÿ≥ŸÉ ÿ•ŸÑŸâ ÿßŸÑŸäŸÖŸäŸÜ Ÿàÿ≥ŸÑŸÖ",
    "turnLeftGreet": "ÿßŸÑÿ™ŸÅÿ™ ÿ®ÿ±ÿ£ÿ≥ŸÉ ÿ•ŸÑŸâ ÿßŸÑŸäÿ≥ÿßÿ± Ÿàÿ≥ŸÑŸÖ",
    "hadithOfTheDay": "ÿ≠ÿØŸäÿ´ ÿßŸÑŸäŸàŸÖ",
    "loadingHadith": "ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ≠ÿØŸäÿ´...",
    "hadithError": "ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ≠ÿØŸäÿ´",
    "refresh": "ÿ™ÿ≠ÿØŸäÿ´",
    "retry": "ÿ•ÿπÿßÿØÿ© ÿßŸÑŸÖÿ≠ÿßŸàŸÑÿ©",
    "prayers": {
      "fajr": "ÿßŸÑŸÅÿ¨ÿ±",
      "dohr": "ÿßŸÑÿ∏Ÿáÿ±",
      "asr": "ÿßŸÑÿπÿµÿ±",
      "maghreb": "ÿßŸÑŸÖÿ∫ÿ±ÿ®",
      "isha": "ÿßŸÑÿπÿ¥ÿßÿ°"
    },
    "surahs": {
      "fatiha": "ÿßŸÑŸÅÿßÿ™ÿ≠ÿ©",
      "ikhlas": "ÿßŸÑÿ•ÿÆŸÑÿßÿµ",
      "falaq": "ÿßŸÑŸÅŸÑŸÇ",
      "nas": "ÿßŸÑŸÜÿßÿ≥",
      "kafirun": "ÿßŸÑŸÉÿßŸÅÿ±ŸàŸÜ",
      "asr": "ÿßŸÑÿπÿµÿ±",
      "qadr": "ÿßŸÑŸÇÿØÿ±"
    },
    "calculationMethods": {
      "3": "ÿ±ÿßÿ®ÿ∑ÿ© ÿßŸÑÿπÿßŸÑŸÖ ÿßŸÑÿ•ÿ≥ŸÑÿßŸÖŸä",
      "2": "ÿßŸÑÿ¨ŸÖÿπŸäÿ© ÿßŸÑÿ•ÿ≥ŸÑÿßŸÖŸäÿ© ŸÑÿ£ŸÖÿ±ŸäŸÉÿß ÿßŸÑÿ¥ŸÖÿßŸÑŸäÿ©",
      "5": "ÿßŸÑŸáŸäÿ¶ÿ© ÿßŸÑŸÖÿµÿ±Ÿäÿ© ÿßŸÑÿπÿßŸÖÿ© ŸÑŸÑŸÖÿ≥ÿßÿ≠ÿ©",
      "4": "ÿ£ŸÖ ÿßŸÑŸÇÿ±Ÿâÿå ŸÖŸÉÿ©",
      "1": "ÿ¨ÿßŸÖÿπÿ© ŸÉÿ±ÿßÿ™ÿ¥Ÿä",
      "0": "ÿßŸÑÿ¥Ÿäÿπÿ© ÿßŸÑÿ•ÿ´ŸÜÿß ÿπÿ¥ÿ±Ÿäÿ©",
      "7": "ÿ∑Ÿáÿ±ÿßŸÜ",
      "8": "ŸÖŸÜÿ∑ŸÇÿ© ÿßŸÑÿÆŸÑŸäÿ¨",
      "9": "ÿßŸÑŸÉŸàŸäÿ™",
      "10": "ŸÇÿ∑ÿ±",
      "11": "ÿ≥ŸÜÿ∫ÿßŸÅŸàÿ±ÿ©",
      "12": "ŸÅÿ±ŸÜÿ≥ÿß",
      "13": "ÿ™ÿ±ŸÉŸäÿß",
      "14": "ÿ±Ÿàÿ≥Ÿäÿß",
      "16": "ÿØÿ®Ÿä",
      "17": "ŸÖÿßŸÑŸäÿ≤Ÿäÿß",
      "18": "ÿ™ŸàŸÜÿ≥",
      "19": "ÿßŸÑÿ¨ÿ≤ÿßÿ¶ÿ±",
      "20": "ÿ•ŸÜÿØŸàŸÜŸäÿ≥Ÿäÿß",
      "21": "ÿßŸÑŸÖÿ∫ÿ±ÿ®",
      "22": "ÿßŸÑÿ®ÿ±ÿ™ÿ∫ÿßŸÑ",
      "23": "ÿßŸÑÿ£ÿ±ÿØŸÜ"
    }
  }
};

        // Function to load translations
        async function loadTranslations() {
            try {
                const response = await fetch('assets/lang/lang.json');
                TRANSLATIONS = await response.json();
                translationsLoaded = true;
                console.log('Translations loaded from external file');
                return true;
            } catch (error) {
                console.warn('Could not load external translations, using inline fallback:', error);
                // Use inline translations as fallback
                TRANSLATIONS = INLINE_TRANSLATIONS;
                translationsLoaded = true;
                return true;
            }
        }

        const LANGUAGES = [
            { code: 'fr', name: 'Fran√ßais', flag: 'üá´üá∑' },
            { code: 'en', name: 'English', flag: 'üá¨üáß' },
            { code: 'ar', name: 'ÿßŸÑÿπÿ±ÿ®Ÿäÿ©', flag: 'üá∏üá¶' }
        ];

        const RECITERS = [
            { id: 'saad-el-ghamidi', name: 'Saad El Ghamidi', arabicName: 'ÿ≥ÿπÿØ ÿßŸÑÿ∫ÿßŸÖÿØŸä' },
            { id: 'abdul-basit', name: 'Abdul Basit', arabicName: 'ÿπÿ®ÿØ ÿßŸÑÿ®ÿßÿ≥ÿ∑ ÿπÿ®ÿØ ÿßŸÑÿµŸÖÿØ' },
            { id: 'mishary-rashid', name: 'Mishary Rashid', arabicName: 'ŸÖÿ¥ÿßÿ±Ÿä ÿßŸÑÿπŸÅÿßÿ≥Ÿä' }
        ];

        const CALCULATION_METHODS = [
            { id: 3, name: 'Muslim World League', nameAr: 'ÿ±ÿßÿ®ÿ∑ÿ© ÿßŸÑÿπÿßŸÑŸÖ ÿßŸÑÿ•ÿ≥ŸÑÿßŸÖŸä', regions: 'üåç' },
            { id: 2, name: 'ISNA (North America)', nameAr: 'ÿßŸÑÿ¨ŸÖÿπŸäÿ© ÿßŸÑÿ•ÿ≥ŸÑÿßŸÖŸäÿ© ŸÑÿ£ŸÖÿ±ŸäŸÉÿß ÿßŸÑÿ¥ŸÖÿßŸÑŸäÿ©', regions: 'üá∫üá∏üá®üá¶' },
            { id: 5, name: 'Egyptian Authority', nameAr: 'ÿßŸÑŸáŸäÿ¶ÿ© ÿßŸÑŸÖÿµÿ±Ÿäÿ© ÿßŸÑÿπÿßŸÖÿ© ŸÑŸÑŸÖÿ≥ÿßÿ≠ÿ©', regions: 'üá™üá¨' },
            { id: 4, name: 'Umm Al-Qura (Makkah)', nameAr: 'ÿ£ŸÖ ÿßŸÑŸÇÿ±Ÿâÿå ŸÖŸÉÿ©', regions: 'üá∏üá¶' },
            { id: 1, name: 'University of Karachi', nameAr: 'ÿ¨ÿßŸÖÿπÿ© ŸÉÿ±ÿßÿ™ÿ¥Ÿä', regions: 'üáµüá∞' },
            { id: 0, name: 'Shia Ithna-Ashari', nameAr: 'ÿßŸÑÿ¥Ÿäÿπÿ© ÿßŸÑÿ•ÿ´ŸÜÿß ÿπÿ¥ÿ±Ÿäÿ©', regions: 'üåô' },
            { id: 7, name: 'Tehran', nameAr: 'ÿ∑Ÿáÿ±ÿßŸÜ', regions: 'üáÆüá∑' },
            { id: 8, name: 'Gulf Region', nameAr: 'ŸÖŸÜÿ∑ŸÇÿ© ÿßŸÑÿÆŸÑŸäÿ¨', regions: 'üá¶üá™üáßüá≠üá¥üá≤' },
            { id: 9, name: 'Kuwait', nameAr: 'ÿßŸÑŸÉŸàŸäÿ™', regions: 'üá∞üáº' },
            { id: 10, name: 'Qatar', nameAr: 'ŸÇÿ∑ÿ±', regions: 'üá∂üá¶' },
            { id: 11, name: 'Singapore', nameAr: 'ÿ≥ŸÜÿ∫ÿßŸÅŸàÿ±ÿ©', regions: 'üá∏üá¨' },
            { id: 12, name: 'France (UOIF)', nameAr: 'ŸÅÿ±ŸÜÿ≥ÿß', regions: 'üá´üá∑' },
            { id: 13, name: 'Turkey (Diyanet)', nameAr: 'ÿ™ÿ±ŸÉŸäÿß', regions: 'üáπüá∑' },
            { id: 14, name: 'Russia', nameAr: 'ÿ±Ÿàÿ≥Ÿäÿß', regions: 'üá∑üá∫' },
            { id: 16, name: 'Dubai', nameAr: 'ÿØÿ®Ÿä', regions: 'üá¶üá™' },
            { id: 17, name: 'Malaysia (JAKIM)', nameAr: 'ŸÖÿßŸÑŸäÿ≤Ÿäÿß', regions: 'üá≤üáæ' },
            { id: 18, name: 'Tunisia', nameAr: 'ÿ™ŸàŸÜÿ≥', regions: 'üáπüá≥' },
            { id: 19, name: 'Algeria', nameAr: 'ÿßŸÑÿ¨ÿ≤ÿßÿ¶ÿ±', regions: 'üá©üáø' },
            { id: 20, name: 'Indonesia (KEMENAG)', nameAr: 'ÿ•ŸÜÿØŸàŸÜŸäÿ≥Ÿäÿß', regions: 'üáÆüá©' },
            { id: 21, name: 'Morocco', nameAr: 'ÿßŸÑŸÖÿ∫ÿ±ÿ®', regions: 'üá≤üá¶' },
            { id: 22, name: 'Portugal', nameAr: 'ÿßŸÑÿ®ÿ±ÿ™ÿ∫ÿßŸÑ', regions: 'üáµüáπ' },
            { id: 23, name: 'Jordan', nameAr: 'ÿßŸÑÿ£ÿ±ÿØŸÜ', regions: 'üáØüá¥' }
        ];

        const PRAYERS = {
            fajr: { name: 'Fajr', rakaats: 2, icon: 'üåÖ', apiKey: 'Fajr' },
            dohr: { name: 'Dohr', rakaats: 4, icon: '‚òÄÔ∏è', apiKey: 'Dhuhr' },
            asr: { name: 'Asr', rakaats: 4, icon: 'üå§Ô∏è', apiKey: 'Asr' },
            maghreb: { name: 'Maghreb', rakaats: 3, icon: 'üåÜ', apiKey: 'Maghrib' },
            isha: { name: 'Isha', rakaats: 4, icon: 'üåô', apiKey: 'Isha' }
        };

        const SURAHS = [
            { 
                id: 'fatiha', 
                name: 'Al-Fatiha', 
                number: 1, 
                arabic: 'ÿßŸÑŸÅÿßÿ™ÿ≠ÿ©', 
                mandatory: true, 
                audioFiles: {
                    'saad-el-ghamidi': 'assets/audio/saad-el-ghamidi-001-al-fatiha-204-9244.mp3',
                    'abdul-basit': 'assets/audio/Abdul-Basit-001-al-fatiha-204-9244.mp3',
                    'mishary-rashid': 'assets/audio/Mishary-Rashid-001-al-fatiha-204-9244.mp3'
                }
            },
            { 
                id: 'ikhlas', 
                name: 'Al-Ikhlas', 
                number: 112, 
                arabic: 'ÿßŸÑÿ•ÿÆŸÑÿßÿµ', 
                audioFiles: {
                    'saad-el-ghamidi': 'assets/audio/saad-el-ghamidi-112-al-ikhlas-201-1223.mp3',
                    'abdul-basit': 'assets/audio/Abdul-Basit-112-al-ikhlas-201-1223.mp3',
                    'mishary-rashid': 'assets/audio/Mishary-Rashid-112-al-ikhlas-201-1223.mp3'
                }
            },
            { 
                id: 'falaq', 
                name: 'Al-Falaq', 
                number: 113, 
                arabic: 'ÿßŸÑŸÅŸÑŸÇ', 
                audioFiles: {
                    'saad-el-ghamidi': 'assets/audio/saad-el-ghamidi-113-al-falaq-202-7322.mp3',
                    'abdul-basit': 'assets/audio/Abdul-Basit-113-al-falaq-202-7322.mp3',
                    'mishary-rashid': 'assets/audio/Mishary-Rashid-113-al-falaq-202-7322.mp3'
                }
            },
            { 
                id: 'nas', 
                name: 'An-Nas', 
                number: 114, 
                arabic: 'ÿßŸÑŸÜÿßÿ≥', 
                audioFiles: {
                    'saad-el-ghamidi': 'assets/audio/saad-el-ghamidi-114-an-nas-203-5140.mp3',
                    'abdul-basit': 'assets/audio/Abdul-Basit-114-an-nas-203-5140.mp3',
                    'mishary-rashid': 'assets/audio/Mishary-Rashid-114-an-nas-203-5140.mp3'
                }
            },
            { 
                id: 'kafirun', 
                name: 'Al-Kafirun', 
                number: 109, 
                arabic: 'ÿßŸÑŸÉÿßŸÅÿ±ŸàŸÜ', 
                audioFiles: {
                    'saad-el-ghamidi': 'assets/audio/saad-el-ghamidi-109-al-kafiroon-198-3820.mp3',
                    'abdul-basit': 'assets/audio/Abdul-Basit-109-al-kafiroon-198-3820.mp3',
                    'mishary-rashid': 'assets/audio/Mishary-Rashid-109-al-kafiroon-198-3820.mp3'
                }
            },
            { 
                id: 'asr', 
                name: 'Al-Asr', 
                number: 103, 
                arabic: 'ÿßŸÑÿπÿµÿ±', 
                audioFiles: {
                    'saad-el-ghamidi': 'assets/audio/saad-el-ghamidi-103-al-asr-192-2834.mp3',
                    'abdul-basit': 'assets/audio/Abdul-Basit-103-al-asr-192-2834.mp3',
                    'mishary-rashid': 'assets/audio/Mishary-Rashid-103-al-asr-192-2834.mp3'
                }
            },
            { 
                id: 'qadr', 
                name: 'Al-Qadr', 
                number: 97, 
                arabic: 'ÿßŸÑŸÇÿØÿ±', 
                audioFiles: {
                    'saad-el-ghamidi': 'assets/audio/saad-el-ghamidi-097-al-qadr-186-6793.mp3',
                    'abdul-basit': 'assets/audio/Abdul-Basit-097-al-qadr-186-6793.mp3',
                    'mishary-rashid': 'assets/audio/Mishary-Rashid-097-al-qadr-186-6793.mp3'
                }
            }
        ];

        function getPositionImage(stepId, avatarGender = 'boy') {
            const suffix = avatarGender === 'girl' ? '-girl.png' : '.png';
            const imageMap = {
                'takbir_ouverture': 'position-debout-main-tete',
                'invocation_ouverture': 'position-debout-main-coeur',
                'refuge': 'position-debout-main-coeur',
                'bismillah': 'position-debout-main-coeur',
                'fatiha': 'position-debout-main-coeur',
                'second_surah': 'position-debout-main-coeur',
                'takbir_ruku': 'position-debout-bras-corps',
                'ruku': 'position-demi-prosternation',
                'qiyam': 'position-debout-bras-corps',
                'apres_qiyam': 'position-debout-bras-corps',
                'takbir_sujud1': 'position-debout-bras-corps',
                'sujud1': 'position-prosternation',
                'takbir_jalsa': 'position-prosternation',
                'jalsa': 'position-assise',
                'takbir_sujud2': 'position-assise',
                'sujud2': 'position-prosternation',
                'takbir_tashahhud': 'position-prosternation',
                'tashahhud': 'position-assise-tahiatou',
                'salat_ibrahimiya': 'position-assise',
                'invocation_finale': 'position-assise',
                'salam_droite': 'position-assise-salam',
                'salam_gauche': 'position-assise-salam'
            };
            const baseName = imageMap[stepId] || 'position-debout-bras-corps';
            return 'assets/images/' + baseName + suffix;
        }

        function getPrayerSteps(t) {
            return [
                { id: 'takbir_ouverture', name: t.takbirOpening, arabic: 'ÿßŸÑŸÑŸéŸëŸáŸè ÿ£ŸéŸÉŸíÿ®Ÿéÿ±Ÿè', transliteration: 'Allahu Akbar', translation: 'God is the Greatest', position: 'standing', action: t.raiseHands, audioFile: 'assets/audio/takbir.mp3', firstRakaatOnly: true, pauseAfter: 1000 },
                { id: 'invocation_ouverture', name: t.openingInvocation, arabic: 'ÿ≥Ÿèÿ®Ÿíÿ≠ŸéÿßŸÜŸéŸÉŸé ÿßŸÑŸÑŸéŸëŸáŸèŸÖŸéŸë ŸàŸéÿ®Ÿêÿ≠ŸéŸÖŸíÿØŸêŸÉŸé', transliteration: 'Subhanakal-lahumma wa bihamdika', translation: 'Glory and praise to You, O Allah', position: 'standing', action: t.reciteOpening, audioFiles: ['assets/audio/ouverture1.mp3', 'assets/audio/ouverture2.mp3', 'assets/audio/ouverture3.mp3'], firstRakaatOnly: true, hasOptions: true, pauseAfter: 1000 },
                { id: 'refuge', name: t.seekingRefuge, arabic: 'ÿ£ŸéÿπŸèŸàÿ∞Ÿè ÿ®ŸêÿßŸÑŸÑŸéŸëŸáŸê ŸÖŸêŸÜŸé ÿßŸÑÿ¥ŸéŸëŸäŸíÿ∑ŸéÿßŸÜŸê ÿßŸÑÿ±ŸéŸëÿ¨ŸêŸäŸÖŸê', transliteration: 'A\'oudhou billahi mina shaytani rajim', translation: 'I seek refuge in Allah from Satan the accursed', position: 'standing', action: t.seekProtection, audioFiles: ['assets/audio/refuge1.mp3', 'assets/audio/refuge2.mp3', 'assets/audio/refuge3.mp3'], firstRakaatOnly: true, hasOptions: true, pauseAfter: 500 },
                { id: 'bismillah', name: t.bismillah, arabic: 'ÿ®Ÿêÿ≥ŸíŸÖŸê ÿßŸÑŸÑŸéŸëŸáŸê ÿßŸÑÿ±ŸéŸëÿ≠ŸíŸÖŸéŸ∞ŸÜŸê ÿßŸÑÿ±ŸéŸëÿ≠ŸêŸäŸÖŸê', transliteration: 'Bismillah ir-Rahman ir-Rahim', translation: 'In the name of Allah, Most Gracious, Most Merciful', position: 'standing', action: t.beginWithName, audioFile: 'assets/audio/bismilah.mp3', firstRakaatOnly: true, pauseAfter: 500 },
                { id: 'fatiha', name: t.reciteFatiha, arabic: 'ÿßŸÑŸíÿ≠ŸéŸÖŸíÿØŸè ŸÑŸêŸÑŸéŸëŸáŸê ÿ±Ÿéÿ®ŸêŸë ÿßŸÑŸíÿπŸéÿßŸÑŸéŸÖŸêŸäŸÜŸé', transliteration: 'Alhamdulillahi rabbil \'alamin', translation: 'Praise be to Allah, Lord of the worlds', position: 'standing', action: t.reciteFatihaAction, surahType: 'fatiha', pauseAfter: 1000 },
                { id: 'second_surah', name: t.secondarySurahStep, arabic: '...', transliteration: '...', translation: 'Recite the chosen surah', position: 'standing', action: t.reciteSecondary, surahType: 'secondary', pauseAfter: 1000, firstTwoRakaatsOnly: true },
                { id: 'takbir_ruku', name: t.takbirRuku, arabic: 'ÿßŸÑŸÑŸéŸëŸáŸè ÿ£ŸéŸÉŸíÿ®Ÿéÿ±Ÿè', transliteration: 'Allahu Akbar', translation: 'God is the Greatest', position: 'standing', action: t.sayTakbirBowing, audioFile: 'assets/audio/takbir.mp3', pauseAfter: 1000 },
                { id: 'ruku', name: t.ruku, arabic: 'ÿ≥Ÿèÿ®Ÿíÿ≠ŸéÿßŸÜŸé ÿ±Ÿéÿ®ŸêŸëŸäŸé ÿßŸÑŸíÿπŸéÿ∏ŸêŸäŸÖŸê', transliteration: 'Subhana Rabbiyal Adheem', translation: 'Glory to my Lord the Great', position: 'bowing', action: t.stayBowing, audioFiles: ['assets/audio/ruku1.mp3', 'assets/audio/Durant_l_inclinaison1.mp3', 'assets/audio/Durant_l_inclinaison2.mp3', 'assets/audio/Durant_l_inclinaison3.mp3', 'assets/audio/Durant_l_inclinaison4.mp3', 'assets/audio/Durant_l_inclinaison5.mp3', 'assets/audio/Durant_l_inclinaison6.mp3', 'assets/audio/Durant_l_inclinaison7.mp3'], hasOptions: true, pauseAfter: 1000 },
                { id: 'qiyam', name: t.qiyam, arabic: 'ÿ≥ŸéŸÖŸêÿπŸé ÿßŸÑŸÑŸéŸëŸáŸè ŸÑŸêŸÖŸéŸÜŸí ÿ≠ŸéŸÖŸêÿØŸéŸáŸè', transliteration: 'Sami Allahu liman hamidah', translation: 'Allah hears those who praise Him', position: 'standing', action: t.standUpSaying, audioFile: 'assets/audio/en_ce_levant1.mp3', pauseAfter: 500 },
                { id: 'apres_qiyam', name: t.afterQiyam, arabic: 'ÿ±Ÿéÿ®ŸéŸëŸÜŸéÿß ŸàŸéŸÑŸéŸÉŸé ÿßŸÑŸíÿ≠ŸéŸÖŸíÿØŸè', transliteration: 'Rabbana wa lakal hamd', translation: 'Our Lord, to You be praise', position: 'standing', action: t.onceStanding, audioFiles: ['assets/audio/unefoislev√©1.mp3', 'assets/audio/unefoislev√©2.mp3', 'assets/audio/unefoislev√©3.mp3', 'assets/audio/unefoislev√©4.mp3', 'assets/audio/unefoislev√©5.mp3', 'assets/audio/unefoislev√©6.mp3'], hasOptions: true, pauseAfter: 1000 },
                { id: 'takbir_sujud1', name: t.takbirSujud, arabic: 'ÿßŸÑŸÑŸéŸëŸáŸè ÿ£ŸéŸÉŸíÿ®Ÿéÿ±Ÿè', transliteration: 'Allahu Akbar', translation: 'God is the Greatest', position: 'standing', action: t.sayTakbirProstrating, audioFile: 'assets/audio/takbir.mp3', pauseAfter: 1000 },
                { id: 'sujud1', name: t.sujud1, arabic: 'ÿ≥Ÿèÿ®Ÿíÿ≠ŸéÿßŸÜŸé ÿ±Ÿéÿ®ŸêŸëŸäŸé ÿßŸÑŸíÿ£ŸéÿπŸíŸÑŸéŸâŸ∞', transliteration: 'Subhana Rabbiyal A\'la', translation: 'Glory to my Lord the Most High', position: 'prostrating', action: t.stayProstrating, audioFiles: ['assets/audio/durantprosternation1.mp3', 'assets/audio/durantprosternation2.mp3'], hasOptions: true, pauseAfter: 1000 },
                { id: 'takbir_jalsa', name: t.takbirSit, arabic: 'ÿßŸÑŸÑŸéŸëŸáŸè ÿ£ŸéŸÉŸíÿ®Ÿéÿ±Ÿè', transliteration: 'Allahu Akbar', translation: 'God is the Greatest', position: 'prostrating', action: t.sayTakbirSitting, audioFile: 'assets/audio/takbir.mp3', pauseAfter: 1000 },
                { id: 'jalsa', name: t.jalsa, arabic: 'ÿ±Ÿéÿ®ŸêŸë ÿßÿ∫ŸíŸÅŸêÿ±Ÿí ŸÑŸêŸä', transliteration: 'Rabbi ghfir li', translation: 'Lord, forgive me', position: 'sitting', action: t.sitBriefly, audioFile: 'assets/audio/takbir.mp3', pauseAfter: 2000 },
                { id: 'takbir_sujud2', name: t.takbirSujud2, arabic: 'ÿßŸÑŸÑŸéŸëŸáŸè ÿ£ŸéŸÉŸíÿ®Ÿéÿ±Ÿè', transliteration: 'Allahu Akbar', translation: 'God is the Greatest', position: 'sitting', action: t.sayTakbirProstrating2, audioFile: 'assets/audio/takbir.mp3', pauseAfter: 1000 },
                { id: 'sujud2', name: t.sujud2, arabic: 'ÿ≥Ÿèÿ®Ÿíÿ≠ŸéÿßŸÜŸé ÿ±Ÿéÿ®ŸêŸëŸäŸé ÿßŸÑŸíÿ£ŸéÿπŸíŸÑŸéŸâŸ∞', transliteration: 'Subhana Rabbiyal A\'la', translation: 'Glory to my Lord the Most High', position: 'prostrating', action: t.prostrateAgain, audioFiles: ['assets/audio/durantprosternation1.mp3', 'assets/audio/durantprosternation2.mp3'], hasOptions: true, pauseAfter: 1000 }
            ];
        }

        function getFinalSteps(t) {
            return [
                { id: 'takbir_tashahhud', name: t.takbirSit, arabic: 'ÿßŸÑŸÑŸéŸëŸáŸè ÿ£ŸéŸÉŸíÿ®Ÿéÿ±Ÿè', transliteration: 'Allahu Akbar', translation: 'God is the Greatest', position: 'prostrating', action: t.standAndSit, audioFile: 'assets/audio/takbir.mp3', pauseAfter: 1000 },
                { id: 'tashahhud', name: t.tashahhud, arabic: 'ÿßŸÑÿ™ŸéŸëÿ≠ŸêŸäŸéŸëÿßÿ™Ÿè ŸÑŸêŸÑŸéŸëŸáŸê', transliteration: 'At-tahiyyatu lillah', translation: 'Salutations are for Allah', position: 'sitting', action: t.reciteTashahhud, audioFile: 'assets/audio/tashaoud1.mp3', pauseAfter: 1000 },
                { id: 'salat_ibrahimiya', name: t.ibrahimicPrayer, arabic: 'ÿßŸÑŸÑŸéŸëŸáŸèŸÖŸéŸë ÿµŸéŸÑŸêŸë ÿπŸéŸÑŸéŸâŸ∞ ŸÖŸèÿ≠ŸéŸÖŸéŸëÿØŸç', transliteration: 'Allahumma salli \'ala Muhammad', translation: 'O Allah, bless Muhammad', position: 'sitting', action: t.reciteIbrahimic, audioFiles: ['assets/audio/ibrahamique_apres_tashaoud1.mp3', 'assets/audio/ibrahamique_apres_tashaou2.mp3'], hasOptions: true, pauseAfter: 1000 },
                { id: 'invocation_finale', name: t.finalInvocation, arabic: 'ÿ±Ÿéÿ®ŸéŸëŸÜŸéÿß ÿ¢ÿ™ŸêŸÜŸéÿß ŸÅŸêŸä ÿßŸÑÿØŸèŸëŸÜŸíŸäŸéÿß ÿ≠Ÿéÿ≥ŸéŸÜŸéÿ©Ÿã', transliteration: 'Rabbana atina fid-dunya hasanah', translation: 'Lord, grant us good in this world', position: 'sitting', action: t.makeInvocations, audioFile: 'assets/audio/invocation_apres_ibrahimique.mp3', pauseAfter: 1000 },
                { id: 'salam_droite', name: t.salamRight, arabic: 'ÿßŸÑÿ≥ŸéŸëŸÑŸéÿßŸÖŸè ÿπŸéŸÑŸéŸäŸíŸÉŸèŸÖŸí ŸàŸéÿ±Ÿéÿ≠ŸíŸÖŸéÿ©Ÿè ÿßŸÑŸÑŸéŸëŸáŸê', transliteration: 'As-salamu \'alaykum wa rahmatullah', translation: 'Peace and mercy of Allah be upon you', position: 'sitting', action: t.turnRightGreet, audioFile: 'assets/audio/salam_final_part1.mp3', pauseAfter: 500 },
                { id: 'salam_gauche', name: t.salamLeft, arabic: 'ÿßŸÑÿ≥ŸéŸëŸÑŸéÿßŸÖŸè ÿπŸéŸÑŸéŸäŸíŸÉŸèŸÖŸí ŸàŸéÿ±Ÿéÿ≠ŸíŸÖŸéÿ©Ÿè ÿßŸÑŸÑŸéŸëŸáŸê', transliteration: 'As-salamu \'alaykum wa rahmatullah', translation: 'Peace and mercy of Allah be upon you', position: 'sitting', action: t.turnLeftGreet, audioFile: 'assets/audio/salam_final_part2.mp3', pauseAfter: 0 }
            ];
        }

        let state = {
            screen: 'home',
            selectedPrayer: null,
            rakaatConfig: [],
            currentRakaat: 1,
            currentStepIndex: 0,
            audioOption: 0,
            scenarioMode: false,
            isPlaying: false,
            language: localStorage.getItem('prayerAppLanguage') || 'fr',
            selectedReciter: localStorage.getItem('prayerAppReciter') || 'saad-el-ghamidi',
            avatarGender: localStorage.getItem('prayerAppAvatar') || 'boy',
            city: localStorage.getItem('prayerAppCity') || '',
            country: localStorage.getItem('prayerAppCountry') || '',
            calculationMethod: parseInt(localStorage.getItem('prayerAppCalculationMethod')) || 3,
            prayerTimes: null,
            currentDate: null,
            loadingPrayerTimes: false,
            dailyHadith: null,
            loadingHadith: false,
            hadithError: null
        };

        let audio = new Audio();
        let audioTimeoutId = null;

        // Hadith Configuration
        const hadithConfig = {
            collections: ['bukhari', 'muslim', 'nawawi'],
            languageMap: {
                'fr': 'fra',
                'en': 'eng',
                'ar': 'ara'
            },
            // Cache for total hadiths per collection
            collectionSizes: {
                'bukhari': 7563,
                'muslim': 7563,
                'nawawi': 42
            }
        };

        // Hadith API Functions
        async function fetchWithFallback(apiLang, collection, hadithNum) {
            const baseUrl = 'https://cdn.jsdelivr.net/gh/fawazahmed0/hadith-api@1/editions';
            
            // Try .min.json first
            try {
                const minUrl = `${baseUrl}/${apiLang}-${collection}/${hadithNum}.min.json`;
                const response = await fetch(minUrl);
                if (response.ok) {
                    return await response.json();
                }
            } catch (error) {
                console.log('Failed to fetch .min.json, trying .json');
            }
            
            // Try .json
            try {
                const jsonUrl = `${baseUrl}/${apiLang}-${collection}/${hadithNum}.json`;
                const response = await fetch(jsonUrl);
                if (response.ok) {
                    return await response.json();
                }
            } catch (error) {
                console.log('Failed to fetch .json');
            }
            
            throw new Error(`Failed to fetch hadith ${hadithNum} from ${collection}`);
        }

        async function fetchDailyHadith(userLang) {
            state.loadingHadith = true;
            state.hadithError = null;
            render();
            
            try {
                // Map user language to API code
                const apiLang = hadithConfig.languageMap[userLang] || 'eng';
                
                // Choose random collection
                const collection = hadithConfig.collections[Math.floor(Math.random() * hadithConfig.collections.length)];
                
                // Get total hadiths for this collection
                const totalHadiths = hadithConfig.collectionSizes[collection] || 1000;
                
                // Generate random hadith number
                const randomNum = Math.floor(Math.random() * totalHadiths) + 1;
                
                // Fetch specific hadith with fallback
                try {
                    const data = await fetchWithFallback(apiLang, collection, randomNum);
                    
                    if (data && data.hadiths && data.hadiths.length > 0) {
                        state.dailyHadith = {
                            text: data.hadiths[0].text,
                            number: data.hadiths[0].hadithnumber || randomNum,
                            collection: data.metadata?.name || collection,
                            section: data.metadata?.section || '',
                            language: apiLang
                        };
                        state.loadingHadith = false;
                        render();
                        return;
                    }
                } catch (error) {
                    // If current language fails and it's not English, try English
                    if (apiLang !== 'eng') {
                        console.log('Trying English fallback...');
                        const dataEng = await fetchWithFallback('eng', collection, randomNum);
                        if (dataEng && dataEng.hadiths && dataEng.hadiths.length > 0) {
                            state.dailyHadith = {
                                text: dataEng.hadiths[0].text,
                                number: dataEng.hadiths[0].hadithnumber || randomNum,
                                collection: dataEng.metadata?.name || collection,
                                section: dataEng.metadata?.section || '',
                                language: 'eng'
                            };
                            state.loadingHadith = false;
                            render();
                            return;
                        }
                    }
                    throw error;
                }
            } catch (error) {
                console.error('Error fetching hadith:', error);
                state.hadithError = 'Could not load hadith';
                state.loadingHadith = false;
                render();
            }
        }

        window.refreshHadith = function() {
            fetchDailyHadith(state.language);
        };

        let timeoutId = null;

        function t() {
            if (!TRANSLATIONS || !TRANSLATIONS[state.language]) {
                return {};
            }
            return TRANSLATIONS[state.language];
        }

        async function fetchPrayerTimes(city, country) {
            if (!city || !country) return;
            
            state.loadingPrayerTimes = true;
            render();
            
            try {
                const now = new Date();
                const day = now.getDate().toString().padStart(2, '0');
                const month = (now.getMonth() + 1).toString().padStart(2, '0');
                const year = now.getFullYear();
                const dateString = `${day}-${month}-${year}`;
                
                const response = await fetch(`https://api.aladhan.com/v1/timingsByCity/${dateString}?city=${encodeURIComponent(city)}&country=${country.toUpperCase()}&method=${state.calculationMethod}`);
                const data = await response.json();
                
                if (data.code === 200 && data.data) {
                    state.prayerTimes = data.data.timings;
                    state.currentDate = data.data.date;
                }
            } catch (error) {
                console.error('Error fetching prayer times:', error);
            } finally {
                state.loadingPrayerTimes = false;
                render();
            }
        }

        function getCurrentSteps() {
            if (!state.selectedPrayer) return [];
            const isLastRakaat = state.currentRakaat === PRAYERS[state.selectedPrayer].rakaats;
            const isFirstRakaat = state.currentRakaat === 1;
            const isFirstTwoRakaats = state.currentRakaat <= 2;
            
            let steps = getPrayerSteps(t()).filter(step => {
                if (step.firstRakaatOnly && !isFirstRakaat) return false;
                if (step.firstTwoRakaatsOnly && !isFirstTwoRakaats) return false;
                return true;
            });
            
            if (isLastRakaat) {
                steps = [...steps, ...getFinalSteps(t())];
            }
            return steps;
        }

        function getCurrentAudioFile() {
            const steps = getCurrentSteps();
            const step = steps[state.currentStepIndex];
            
            if (step.surahType === 'fatiha') {
                return SURAHS[0].audioFiles[state.selectedReciter];
            } else if (step.surahType === 'secondary') {
                const secondarySurah = state.rakaatConfig[state.currentRakaat - 1]?.secondarySurah;
                return secondarySurah?.audioFiles[state.selectedReciter];
            } else if (step.audioFile) {
                return step.audioFile;
            } else if (step.audioFiles && step.audioFiles.length > 0) {
                return step.audioFiles[state.audioOption % step.audioFiles.length];
            }
            return null;
        }

        function playAudio() {
            const audioFile = getCurrentAudioFile();
            if (!audioFile) return;
            
            audio.src = audioFile;
            audio.play().then(() => {
                state.isPlaying = true;
                render();
            }).catch(err => {
                console.error('Erreur de lecture audio:', err);
            });
        }

        function stopAudio() {
            audio.pause();
            audio.currentTime = 0;
            state.isPlaying = false;
        }

        function nextStep() {
            const steps = getCurrentSteps();
            if (state.currentStepIndex < steps.length - 1) {
                state.currentStepIndex++;
            } else if (state.currentRakaat < PRAYERS[state.selectedPrayer].rakaats) {
                state.currentRakaat++;
                state.currentStepIndex = 0;
            }
            stopAudio();
            state.audioOption = 0;
            render();
            
            if (state.scenarioMode) {
                setTimeout(() => playAudio(), 300);
            }
        }

        function previousStep() {
            if (state.currentStepIndex > 0) {
                state.currentStepIndex--;
            } else if (state.currentRakaat > 1) {
                state.currentRakaat--;
                const prevSteps = getCurrentSteps();
                state.currentStepIndex = prevSteps.length - 1;
            }
            stopAudio();
            state.audioOption = 0;
            render();
        }

        audio.onended = () => {
            state.isPlaying = false;
            render();
            
            if (state.scenarioMode) {
                const steps = getCurrentSteps();
                const step = steps[state.currentStepIndex];
                const pauseDuration = step.pauseAfter || 1000;
                
                timeoutId = setTimeout(() => {
                    const isLastStep = state.currentRakaat === PRAYERS[state.selectedPrayer].rakaats && 
                                      state.currentStepIndex === steps.length - 1;
                    if (!isLastStep) {
                        nextStep();
                    }
                }, pauseDuration);
            }
        };

        function render() {
            const app = document.getElementById('app');
            const trans = t();
            const isRTL = state.language === 'ar';
            const dirAttr = isRTL ? 'rtl' : 'ltr';
            
            if (state.screen === 'home') {
                app.innerHTML = `
                    <div class="max-w-4xl mx-auto p-6" dir="${dirAttr}">
                        <div class="flex justify-between mb-4">
                            <button onclick="goToSettings()" class="bg-white rounded-xl shadow-lg px-4 py-2 flex items-center gap-2 hover:shadow-xl transition-all border-2 border-teal-100">
                                <span class="text-xl">‚öôÔ∏è</span>
                                <span class="font-medium text-teal-800">${trans.settings}</span>
                            </button>
                            
                            <div class="relative inline-block">
                                <button onclick="toggleLanguageMenu()" class="bg-white rounded-xl shadow-lg px-4 py-2 flex items-center gap-2 hover:shadow-xl transition-all border-2 border-teal-100">
                                    <span class="text-2xl">${LANGUAGES.find(l => l.code === state.language).flag}</span>
                                    <span class="font-medium text-teal-800">${LANGUAGES.find(l => l.code === state.language).name}</span>
                                    <span>‚ñº</span>
                                </button>
                                <div id="languageMenu" class="hidden absolute ${isRTL ? 'left-0' : 'right-0'} mt-2 bg-white rounded-xl shadow-xl border-2 border-teal-100 overflow-hidden z-10">
                                    ${LANGUAGES.map(lang => `
                                        <button onclick="changeLanguage('${lang.code}')" class="w-full px-4 py-3 flex items-center gap-3 hover:bg-teal-50 transition-colors ${state.language === lang.code ? 'bg-teal-100' : ''}">
                                            <span class="text-2xl">${lang.flag}</span>
                                            <span class="font-medium">${lang.name}</span>
                                        </button>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                        
                        <div class="text-center mb-12 pt-8">
                            <div class="text-6xl mb-4">üïå</div>
                            <h1 class="text-4xl font-bold text-teal-800 mb-2">${trans.appTitle}</h1>
                            <p class="text-teal-600">${trans.subtitle}</p>
                            <p class="text-sm text-teal-500 mt-2">${trans.reciter}: ${RECITERS.find(r => r.id === state.selectedReciter).name}</p>
                            ${state.city && state.country ? `<p class="text-sm text-teal-500">${state.city}, ${state.country.toUpperCase()}</p>` : ''}
                        </div>
                        
                        ${state.loadingPrayerTimes ? `
                            <div class="text-center mb-8">
                                <p class="text-teal-600">${trans.loadingPrayerTimes}</p>
                            </div>
                        ` : ''}
                        
                        ${state.currentDate ? `
                            <div class="text-center mb-6 bg-white rounded-2xl shadow-lg p-4 border-2 border-teal-100">
                                <div class="flex items-center justify-center gap-3">
                                    <span class="text-2xl">üìÖ</span>
                                    <div>
                                        <p class="text-sm text-gray-600">${state.currentDate.hijri.weekday.ar} - ${state.currentDate.hijri.day} ${state.currentDate.hijri.month.ar} ${state.currentDate.hijri.year}</p>
                                        <p class="text-lg font-bold text-teal-800">${state.currentDate.gregorian.weekday.en}, ${state.currentDate.gregorian.day} ${state.currentDate.gregorian.month.en} ${state.currentDate.gregorian.year}</p>
                                    </div>
                                </div>
                            </div>
                        ` : ''}
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            ${Object.entries(PRAYERS).map(([key, prayer]) => {
                                const prayerTime = state.prayerTimes ? state.prayerTimes[prayer.apiKey] : null;
                                return `
                                    <button onclick="selectPrayer('${key}')" class="bg-white rounded-2xl shadow-lg hover:shadow-xl transition-all p-8 border-2 border-teal-100 hover:border-teal-300 hover:scale-105">
                                        <div class="text-6xl mb-4">${prayer.icon}</div>
                                        <h3 class="text-2xl font-bold text-teal-800 mb-2">${trans.prayers[key] || prayer.name}</h3>
                                        <p class="text-teal-600">${prayer.rakaats} ${trans.rakaats}</p>
                                        ${prayerTime ? `
                                            <p class="text-xl font-bold text-teal-700 mt-2">${prayerTime}</p>
                                        ` : ''}
                                    </button>
                                `;
                            }).join('')}
                        </div>
                        
                        <!-- Hadith du Jour - Compact -->
                        ${state.dailyHadith ? `
                            <div class="mt-8 bg-gradient-to-r from-amber-50 to-orange-50 rounded-xl shadow p-4 border border-amber-200" dir="${state.dailyHadith.language === 'ara' || state.dailyHadith.language === 'urd' ? 'rtl' : 'ltr'}">
                                <div class="flex items-start justify-between gap-3">
                                    <div class="flex-1">
                                        <div class="flex items-center gap-2 mb-2">
                                            <span class="text-lg">üìñ</span>
                                            <h3 class="text-sm font-bold text-amber-900">${trans.hadithOfTheDay || 'Hadith du Jour'}</h3>
                                        </div>
                                        <div class="bg-white/80 rounded-lg p-3 mb-2">
                                            <p class="text-sm text-gray-700 leading-relaxed ${state.dailyHadith.language === 'ara' || state.dailyHadith.language === 'urd' ? 'text-right font-arabic' : 'text-left'}">${state.dailyHadith.text}</p>
                                        </div>
                                        <div class="flex items-center justify-between text-xs text-amber-700">
                                            <span class="font-medium">${state.dailyHadith.collection}</span>
                                            <span>#${state.dailyHadith.number}</span>
                                        </div>
                                    </div>
                                    <button onclick="refreshHadith()" class="text-amber-600 hover:text-amber-800 transition-colors flex-shrink-0 p-1" title="${trans.refresh || 'Rafra√Æchir'}">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                                        </svg>
                                    </button>
                                </div>
                            </div>
                        ` : state.loadingHadith ? `
                            <div class="mt-8 bg-amber-50 rounded-xl shadow p-4 border border-amber-200 text-center">
                                <p class="text-sm text-amber-700 animate-pulse">üìñ ${trans.loadingHadith || 'Chargement du hadith...'}</p>
                            </div>
                        ` : state.hadithError ? `
                            <div class="mt-8 bg-red-50 rounded-xl shadow p-4 border border-red-200">
                                <div class="flex items-center justify-between">
                                    <p class="text-sm text-red-700">‚ö†Ô∏è ${trans.hadithError || 'Erreur'}</p>
                                    <button onclick="refreshHadith()" class="bg-red-100 hover:bg-red-200 text-red-700 px-3 py-1 rounded text-xs transition-colors">
                                        ${trans.retry || 'R√©essayer'}
                                    </button>
                                </div>
                            </div>
                        ` : ''}
                    </div>
                `;
            } else if (state.screen === 'settings') {
                app.innerHTML = `
                    <div class="max-w-4xl mx-auto p-6" dir="${dirAttr}">
                        <div class="flex items-center justify-between mb-8">
                            <button onclick="goHome()" class="flex items-center gap-2 text-teal-700 hover:text-teal-900">
                                <span>${isRTL ? '‚Üê' : '‚Üê'} ${trans.back}</span>
                            </button>
                            <h1 class="text-3xl font-bold text-teal-800">${trans.settings}</h1>
                            <div class="w-24"></div>
                        </div>
                        
                        <div class="space-y-6">
                            <!-- Localisation -->
                            <div class="bg-white rounded-2xl shadow-lg p-6 border-2 border-teal-100">
                                <h3 class="text-xl font-bold text-teal-800 mb-4 flex items-center gap-2">
                                    <span>üìç</span>
                                    <span>${trans.location}</span>
                                </h3>
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">${trans.city}</label>
                                        <input 
                                            type="text" 
                                            id="cityInput" 
                                            placeholder="${trans.cityPlaceholder}"
                                            value="${state.city}"
                                            onchange="updateCity(this.value)"
                                            class="w-full p-4 border-2 border-gray-200 rounded-xl focus:border-teal-500 focus:outline-none text-lg"
                                        />
                                        <p class="text-sm text-gray-600 mt-1">${trans.enterCity}</p>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">${trans.country}</label>
                                        <input 
                                            type="text" 
                                            id="countryInput" 
                                            placeholder="${trans.countryPlaceholder}"
                                            value="${state.country}"
                                            onchange="updateCountry(this.value)"
                                            maxlength="2"
                                            class="w-full p-4 border-2 border-gray-200 rounded-xl focus:border-teal-500 focus:outline-none text-lg uppercase"
                                        />
                                        <p class="text-sm text-gray-600 mt-1">${trans.enterCountry}</p>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- M√©thode de calcul -->
                            <div class="bg-white rounded-2xl shadow-lg p-6 border-2 border-teal-100">
                                <h3 class="text-xl font-bold text-teal-800 mb-4 flex items-center gap-2">
                                    <span>üìê</span>
                                    <span>${trans.selectCalculationMethod}</span>
                                </h3>
                                <div class="space-y-2 max-h-96 overflow-y-auto">
                                    ${CALCULATION_METHODS.map(method => `
                                        <button onclick="selectCalculationMethod(${method.id})" class="w-full p-3 rounded-xl border-2 transition-all text-left ${state.calculationMethod === method.id ? 'bg-teal-100 border-teal-500' : 'bg-gray-50 border-gray-200 hover:border-teal-300'}">
                                            <div class="flex items-center justify-between">
                                                <div class="flex items-center gap-2">
                                                    <span class="text-lg">${method.regions}</span>
                                                    <div>
                                                        <p class="font-bold text-gray-800 text-sm">${trans.calculationMethods[method.id] || method.name}</p>
                                                        <p class="text-xs text-gray-600">${isRTL ? trans.calculationMethods[method.id] : method.nameAr}</p>
                                                    </div>
                                                </div>
                                                ${state.calculationMethod === method.id ? '<span class="text-xl">‚úî</span>' : ''}
                                            </div>
                                        </button>
                                    `).join('')}
                                </div>
                            </div>
                            
                            <!-- S√©lection du r√©citateur -->
                            <div class="bg-white rounded-2xl shadow-lg p-6 border-2 border-teal-100">
                                <h3 class="text-xl font-bold text-teal-800 mb-4 flex items-center gap-2">
                                    <span>üéôÔ∏è</span>
                                    <span>${trans.selectReciter}</span>
                                </h3>
                                <div class="space-y-3">
                                    ${RECITERS.map(reciter => `
                                        <button onclick="selectReciter('${reciter.id}')" class="w-full p-4 rounded-xl border-2 transition-all ${state.selectedReciter === reciter.id ? 'bg-teal-100 border-teal-500' : 'bg-gray-50 border-gray-200 hover:border-teal-300'}">
                                            <div class="flex items-center justify-between">
                                                <div class="text-left">
                                                    <p class="font-bold text-gray-800">${reciter.name}</p>
                                                    <p class="text-sm text-gray-600">${reciter.arabicName}</p>
                                                </div>
                                                ${state.selectedReciter === reciter.id ? '<span class="text-2xl">‚úî</span>' : ''}
                                            </div>
                                        </button>
                                    `).join('')}
                                </div>
                            </div>
                            
                            <!-- S√©lection de l'avatar -->
                            <div class="bg-white rounded-2xl shadow-lg p-6 border-2 border-teal-100">
                                <h3 class="text-xl font-bold text-teal-800 mb-4 flex items-center gap-2">
                                    <span>üë§</span>
                                    <span>${trans.selectAvatar}</span>
                                </h3>
                                <div class="grid grid-cols-2 gap-4">
                                    <button onclick="selectAvatar('boy')" class="p-6 rounded-xl border-2 transition-all ${state.avatarGender === 'boy' ? 'bg-blue-100 border-blue-500' : 'bg-gray-50 border-gray-200 hover:border-blue-300'}">
                                        <div class="flex flex-col items-center gap-3">
                                            <img src="assets/images/position-debout-main-coeur.png" class="h-32 object-contain">
                                            <p class="font-bold text-gray-800">${trans.boy}</p>
                                            ${state.avatarGender === 'boy' ? '<span class="text-2xl">‚úî</span>' : ''}
                                        </div>
                                    </button>
                                    <button onclick="selectAvatar('girl')" class="p-6 rounded-xl border-2 transition-all ${state.avatarGender === 'girl' ? 'bg-pink-100 border-pink-500' : 'bg-gray-50 border-gray-200 hover:border-pink-300'}">
                                        <div class="flex flex-col items-center gap-3">
                                            <img src="assets/images/position-debout-main-coeur-girl.png" class="h-32 object-contain">
                                            <p class="font-bold text-gray-800">${trans.girl}</p>
                                            ${state.avatarGender === 'girl' ? '<span class="text-2xl">‚úî</span>' : ''}
                                        </div>
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Section Dons -->
                        <div class="bg-gradient-to-r from-emerald-50 to-teal-50 rounded-2xl shadow-lg p-6 border-2 border-emerald-200 mt-6">
                            <h3 class="text-xl font-bold text-emerald-800 mb-3 flex items-center gap-2">
                                <span>üíö</span>
                                <span>${trans.donations}</span>
                            </h3>
                            <p class="text-gray-700 mb-4 text-sm leading-relaxed">${trans.donationsMessage}</p>
                            <a href="https://www.paypal.com/paypalme/MDRIOUECH" target="_blank" rel="noopener noreferrer" class="inline-block bg-gradient-to-r from-emerald-500 to-teal-500 text-white px-6 py-3 rounded-xl font-medium hover:shadow-lg transition-all">
                                üíù ${trans.supportProject}
                            </a>
                        </div>
                        
                        <!-- Section Open-Source -->
                        <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-2xl shadow-lg p-6 border-2 border-blue-200 mt-6">
                            <h3 class="text-xl font-bold text-blue-800 mb-3 flex items-center gap-2">
                                <span>üìÇ</span>
                                <span>${trans.openSource}</span>
                            </h3>
                            <p class="text-gray-700 mb-3 text-sm leading-relaxed">${trans.openSourceMessage}</p>
                            <div class="bg-amber-50 border-2 border-amber-300 rounded-xl p-4 mb-4">
                                <p class="text-amber-900 text-sm font-medium">${trans.openSourceWarning}</p>
                            </div>
                            <div class="flex flex-col sm:flex-row gap-3">
                                <a href="https://github.com/MehdyDriouech/MyPocketImam/" target="_blank" rel="noopener noreferrer" class="flex-1 bg-gray-800 text-white px-6 py-3 rounded-xl font-medium hover:bg-gray-900 transition-all text-center flex items-center justify-center gap-2">
                                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/></svg>
                                    ${trans.viewOnGithub}
                                </a>
                                <button onclick="downloadSourceCode()" class="flex-1 bg-gradient-to-r from-blue-500 to-indigo-500 text-white px-6 py-3 rounded-xl font-medium hover:shadow-lg transition-all flex items-center justify-center gap-2">
                                    <span>‚¨áÔ∏è</span>
                                    ${trans.downloadCode}
                                </button>
                            </div>
                        </div>
                        
                        <button onclick="saveSettings()" class="w-full mt-8 bg-gradient-to-r from-teal-500 to-emerald-500 text-white text-xl font-bold py-6 rounded-2xl shadow-lg hover:shadow-xl transition-all hover:scale-105">
                            ${trans.saveSettings}
                        </button>
                    </div>
                `;
            } else if (state.screen === 'config') {
                app.innerHTML = `
                    <div class="max-w-4xl mx-auto p-6" dir="${dirAttr}">
                        <div class="flex items-center justify-between mb-8">
                            <button onclick="goHome()" class="flex items-center gap-2 text-teal-700 hover:text-teal-900">
                                <span>${isRTL ? '‚Üê' : '‚Üê'} ${trans.back}</span>
                            </button>
                            <h1 class="text-3xl font-bold text-teal-800">${trans.configuration} ${trans.prayers[state.selectedPrayer] || PRAYERS[state.selectedPrayer].name}</h1>
                            <div class="w-24"></div>
                        </div>
                        
                        <div class="bg-gradient-to-r from-teal-500 to-emerald-500 rounded-2xl shadow-lg p-6 mb-8 text-white">
                            <div class="flex items-center gap-3">
                                <svg class="w-7 h-7" fill="currentColor" viewBox="0 0 24 24"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02z"/></svg>
                                <div>
                                    <p class="text-sm opacity-90">${trans.reciter}</p>
                                    <p class="text-xl font-bold">${RECITERS.find(r => r.id === state.selectedReciter).name}</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="space-y-6 mb-8">
                            ${state.rakaatConfig.map((config, index) => `
                                <div class="bg-white rounded-2xl shadow-lg p-6 border-2 border-teal-100">
                                    <div class="flex items-center gap-3 mb-4">
                                        <div class="bg-teal-500 text-white rounded-full w-10 h-10 flex items-center justify-center font-bold">${config.rakaat}</div>
                                        <h3 class="text-xl font-bold text-teal-800">${trans.rakaat} ${config.rakaat}</h3>
                                    </div>
                                    <div class="mb-4 p-4 bg-teal-50 rounded-xl border-2 border-teal-200">
                                        <div class="flex items-center justify-between">
                                            <div>
                                                <p class="font-bold text-teal-800">${trans.mandatorySurah}</p>
                                                <p class="text-sm text-teal-600 ${isRTL ? 'text-left' : 'text-right'}">${SURAHS[0].arabic}</p>
                                            </div>
                                        </div>
                                    </div>
                                    ${config.rakaat <= 2 ? `
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">${trans.secondarySurah}</label>
                                            <select onchange="updateSurah(${index}, this.value)" class="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-teal-500 focus:outline-none">
                                                ${SURAHS.filter(s => !s.mandatory).map(surah => `
                                                    <option value="${surah.id}" ${config.secondarySurah.id === surah.id ? 'selected' : ''}>
                                                        ${trans.surahs[surah.id] || surah.name} - ${surah.arabic} (${surah.number})
                                                    </option>
                                                `).join('')}
                                            </select>
                                        </div>
                                    ` : `
                                        <div class="p-4 bg-gray-50 rounded-xl border-2 border-gray-200">
                                            <p class="text-sm text-gray-600 italic">
                                                ‚ÑπÔ∏è ${trans.infoRakaat34}
                                            </p>
                                        </div>
                                    `}
                                </div>
                            `).join('')}
                        </div>
                        
                        <button onclick="startGuidance()" class="w-full bg-gradient-to-r from-teal-500 to-emerald-500 text-white text-xl font-bold py-6 rounded-2xl shadow-lg hover:shadow-xl transition-all hover:scale-105">
                            ‚ñ∂ ${trans.startGuidance}
                        </button>
                    </div>
                `;
            } else if (state.screen === 'guidance') {
                const steps = getCurrentSteps();
                const step = steps[state.currentStepIndex];
                const isLastStep = state.currentRakaat === PRAYERS[state.selectedPrayer].rakaats && state.currentStepIndex === steps.length - 1;
                const audioFile = getCurrentAudioFile();
                const totalSteps = PRAYERS[state.selectedPrayer].rakaats * getPrayerSteps(trans).length + getFinalSteps(trans).length;
                const currentAbsoluteStep = (state.currentRakaat - 1) * getPrayerSteps(trans).length + state.currentStepIndex + 1;
                const progress = (currentAbsoluteStep / totalSteps) * 100;
                const positionImage = getPositionImage(step.id, state.avatarGender);
                
                app.innerHTML = `
                    <div class="max-w-4xl mx-auto p-6" dir="${dirAttr}">
                        <div class="flex items-center justify-between mb-6">
                            <button onclick="goToConfig()" class="flex items-center gap-2 text-teal-700 hover:text-teal-900">
                                <span>‚öôÔ∏è ${trans.config}</span>
                            </button>
                            <div class="text-center">
                                <h1 class="text-2xl font-bold text-teal-800">${trans.prayers[state.selectedPrayer] || PRAYERS[state.selectedPrayer].name}</h1>
                                <p class="text-teal-600">${trans.rakaat} ${state.currentRakaat}/${PRAYERS[state.selectedPrayer].rakaats}</p>
                            </div>
                            <button onclick="goHome()" class="flex items-center gap-2 text-teal-700 hover:text-teal-900">
                                <span>üè†</span>
                            </button>
                        </div>
                        
                        <div class="mb-6 bg-white rounded-2xl shadow-lg p-4 border-2 border-teal-100">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-3">
                                    <span class="text-2xl">üé¨</span>
                                    <div>
                                        <p class="font-bold text-teal-800">${trans.scenarioMode}</p>
                                        <p class="text-sm text-gray-600">${trans.automaticFlow}</p>
                                    </div>
                                </div>
                                <button onclick="toggleScenario()" class="relative inline-flex h-8 w-14 items-center rounded-full transition-colors ${state.scenarioMode ? 'bg-teal-500' : 'bg-gray-300'}">
                                    <span class="inline-block h-6 w-6 transform rounded-full bg-white transition-transform ${state.scenarioMode ? 'translate-x-7' : 'translate-x-1'}"></span>
                                </button>
                            </div>
                            ${state.scenarioMode ? `
                                <div class="mt-3 p-3 bg-teal-50 rounded-xl">
                                    <p class="text-sm text-teal-700">üé¨ ${trans.automaticActive}</p>
                                </div>
                            ` : ''}
                        </div>
                        
                        <div class="mb-8">
                            <div class="w-full bg-gray-200 rounded-full h-3 overflow-hidden">
                                <div class="bg-gradient-to-r from-teal-500 to-emerald-500 h-full transition-all duration-500 rounded-full" style="width: ${progress}%"></div>
                            </div>
                        </div>
                        
                        <div class="bg-white rounded-3xl shadow-2xl p-12 mb-8 border-2 border-teal-100">
                            <div class="flex justify-center items-center mb-8">
                                <img src="${positionImage}" alt="${step.name}" class="prayer-image">
                            </div>
                            
                            <div class="text-center space-y-4">
                                <h2 class="text-3xl font-bold text-teal-800">${step.name}</h2>
                                <p class="text-lg text-gray-600 italic">${step.action}</p>
                                
                                <div class="bg-teal-50 rounded-2xl p-6 space-y-3">
                                    <p class="text-4xl font-arabic leading-loose">${step.arabic}</p>
                                    <p class="text-xl text-teal-700 font-medium">${step.transliteration}</p>
                                    <p class="text-lg text-gray-700">${step.translation}</p>
                                </div>
                                
                                ${audioFile ? `
                                    <div class="space-y-2">
                                        ${!state.scenarioMode ? `
                                            <button onclick="toggleAudio()" class="bg-teal-500 text-white px-8 py-4 rounded-full font-medium hover:bg-teal-600 transition-all flex items-center gap-3 mx-auto shadow-lg">
                                                <span>${state.isPlaying ? '‚è∏Ô∏è' : 'üîä'}</span>
                                                ${state.isPlaying ? trans.pause : trans.listenRecitation}
                                            </button>
                                        ` : `
                                            <div class="flex items-center justify-center gap-2 text-teal-600">
                                                <span class="animate-pulse">üîä</span>
                                                <span class="text-sm font-medium">${state.isPlaying ? trans.playing : trans.waiting}</span>
                                            </div>
                                        `}
                                        
                                        ${!state.scenarioMode && step.hasOptions && step.audioFiles && step.audioFiles.length > 1 ? `
                                            <div class="flex items-center justify-center gap-2">
                                                <button onclick="changeVariant(-1)" class="text-teal-600 hover:text-teal-800 px-3 py-1 rounded">${isRTL ? '‚ñ∫' : '‚óÑ'}</button>
                                                <span class="text-sm text-teal-600">${trans.variant} ${state.audioOption + 1}/${step.audioFiles.length}</span>
                                                <button onclick="changeVariant(1)" class="text-teal-600 hover:text-teal-800 px-3 py-1 rounded">${isRTL ? '‚óÑ' : '‚ñ∫'}</button>
                                            </div>
                                        ` : ''}
                                        
                                        <p class="text-sm text-teal-600">${trans.reciter}: ${RECITERS.find(r => r.id === state.selectedReciter).name}</p>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                        
                        ${!state.scenarioMode ? `
                            <div class="flex gap-4">
                                <button onclick="previousStep()" ${state.currentRakaat === 1 && state.currentStepIndex === 0 ? 'disabled' : ''} class="flex-1 bg-white text-teal-700 font-bold py-4 rounded-xl shadow-lg hover:shadow-xl transition-all disabled:opacity-50 disabled:cursor-not-allowed border-2 border-teal-200">
                                    ${isRTL ? '‚ñ∫' : '‚óÑ'} ${trans.previous}
                                </button>
                                <button onclick="nextStep()" ${isLastStep ? 'disabled' : ''} class="flex-1 bg-gradient-to-r from-teal-500 to-emerald-500 text-white font-bold py-4 rounded-xl shadow-lg hover:shadow-xl transition-all disabled:opacity-50 disabled:cursor-not-allowed">
                                    ${trans.next} ${isRTL ? '‚óÑ' : '‚ñ∫'}
                                </button>
                            </div>
                        ` : ''}
                        
                        ${isLastStep ? `
                            <div class="mt-6 bg-emerald-100 border-2 border-emerald-300 rounded-2xl p-6 text-center">
                                <p class="text-2xl font-bold text-emerald-800 mb-2">üéâ ${trans.prayerComplete}</p>
                                <p class="text-emerald-700">${trans.prayerAccepted}</p>
                                <button onclick="goHome()" class="mt-4 bg-emerald-500 text-white px-6 py-3 rounded-xl font-medium hover:bg-emerald-600 transition-all">
                                    ${trans.returnHome}
                                </button>
                            </div>
                        ` : ''}
                    </div>
                `;
            }
        }

        window.toggleLanguageMenu = () => {
            const menu = document.getElementById('languageMenu');
            menu.classList.toggle('hidden');
        };

        window.changeLanguage = (lang) => {
            state.language = lang;
            localStorage.setItem('prayerAppLanguage', lang);
            document.documentElement.lang = lang;
            // Reload hadith in new language
            fetchDailyHadith(lang);
            render();
        };

        window.goToSettings = () => {
            state.screen = 'settings';
            render();
        };

        window.updateCity = (city) => {
            state.city = city;
        };

        window.updateCountry = (country) => {
            state.country = country.toUpperCase();
        };

        window.selectCalculationMethod = (methodId) => {
            state.calculationMethod = methodId;
            render();
        };

        window.selectReciter = (reciterId) => {
            state.selectedReciter = reciterId;
            render();
        };

        window.selectAvatar = (gender) => {
            state.avatarGender = gender;
            render();
        };

        window.saveSettings = () => {
            localStorage.setItem('prayerAppReciter', state.selectedReciter);
            localStorage.setItem('prayerAppAvatar', state.avatarGender);
            localStorage.setItem('prayerAppCity', state.city);
            localStorage.setItem('prayerAppCountry', state.country);
            localStorage.setItem('prayerAppCalculationMethod', state.calculationMethod);
            
            if (state.city && state.country) {
                fetchPrayerTimes(state.city, state.country);
            }
            
            state.screen = 'home';
            render();
        };

        window.selectPrayer = (prayerId) => {
            state.selectedPrayer = prayerId;
            state.rakaatConfig = Array.from({ length: PRAYERS[prayerId].rakaats }, (_, i) => ({
                rakaat: i + 1,
                secondarySurah: SURAHS.find(s => s.id === 'ikhlas')
            }));
            state.screen = 'config';
            render();
        };

        window.updateSurah = (index, surahId) => {
            state.rakaatConfig[index].secondarySurah = SURAHS.find(s => s.id === surahId);
            render();
        };

        window.startGuidance = () => {
            state.currentRakaat = 1;
            state.currentStepIndex = 0;
            state.screen = 'guidance';
            render();
        };

        window.goHome = () => {
            stopAudio();
            state.scenarioMode = false;
            state.screen = 'home';
            render();
        };

        window.goToConfig = () => {
            stopAudio();
            state.scenarioMode = false;
            state.screen = 'config';
            render();
        };

        window.toggleAudio = () => {
            if (state.isPlaying) {
                stopAudio();
            } else {
                playAudio();
            }
            render();
        };

        window.toggleScenario = () => {
            state.scenarioMode = !state.scenarioMode;
            if (state.scenarioMode) {
                playAudio();
            } else {
                stopAudio();
                if (timeoutId) clearTimeout(timeoutId);
            }
            render();
        };

        window.changeVariant = (direction) => {
            const steps = getCurrentSteps();
            const step = steps[state.currentStepIndex];
            if (step.audioFiles) {
                state.audioOption = (state.audioOption + direction + step.audioFiles.length) % step.audioFiles.length;
                stopAudio();
                render();
            }
        };

        window.nextStep = nextStep;
        window.previousStep = previousStep;

        window.downloadSourceCode = () => {
            const link = document.createElement('a');
            link.href = 'prayer-guidance-app-source.zip';
            link.download = 'prayer-guidance-app-source.zip';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };

        document.addEventListener('click', (e) => {
            const menu = document.getElementById('languageMenu');
            if (menu && !e.target.closest('button')) {
                menu.classList.add('hidden');
            }
        });

        // Initialize the application
        async function initializeApp() {
            // Load translations first
            await loadTranslations();
            
            // Then fetch prayer times if city and country are set
            if (state.city && state.country) {
                fetchPrayerTimes(state.city, state.country);
            }
            
            // Load daily hadith
            fetchDailyHadith(state.language);
            
            // Finally render the app
            render();
        }
        
        // Start the application
        initializeApp();
    </script>
</body>
</html>
